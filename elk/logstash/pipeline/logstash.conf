input {
  # Docker logging driver (gelf) buraya UDP ile gönderir
  gelf {
    port => 12201
  }
}

#filter {
#  # gelf alanlarından index-friendly alanlar türet
#  mutate {
#    add_field => {
#      "app_tag" => "%{[full_message][tag]}"
#    }
#  }
#}

filter {
  # NGINX stdout JSON access log
  json {
    source => "message"
    skip_on_invalid_json => true
  }

  # status integer'a çevir (varsa)
  if [status] {
    mutate { convert => { "status" => "integer" } }
  }

  # SLA OK: 2xx -> 1, diğerleri -> 0
  ruby {
    code => '
      s = event.get("status")
      if s.is_a?(Integer) && s >= 200 && s < 300
        event.set("sla_ok", 1)
      else
        event.set("sla_ok", 0)
      end
    '
  }

  # İsteğe bağlı: request_time saniyeyi ms'ye çevir
  if [request_time] {
    mutate { convert => { "request_time" => "float" } }
    ruby   { code => 'event.set("duration_ms", (event.get("request_time").to_f * 1000.0).round)' }
  }

  # İsteğe bağlı: path'i normalize et (query'siz)
  if [path] {
    mutate { rename => { "path" => "url_path" } }
  }
}

output {
  stdout { codec => rubydebug }

  elasticsearch {
    hosts  => ["http://elasticsearch:9200"]
    index  => "docker-logs-%{+YYYY.MM.dd}"
    # xpack kapalı olduğu için auth yok
  }
}
